<!DOCTYPE html>

<title>ELITR Online Text Flow</title>

<style>
  .row {
    display: flex;
    flex-direction: row;
  }

  .column {
    flex: 1 1 50%;
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
  }

  .events {
    padding-bottom: 30px;
    padding-right: 10px;
  }

  .complete {
    display: table-row-group;
    color: black;
  }

  .expected {
    display: table-row-group;
    color: gray;
  }

  .incoming {
    display: table-row-group;
    color: silver;
  }

  .flow {
    display: table;
  }

  .data {
    display: table-row;
  }

  .item {
    display: table-cell;
    padding-right: 10px;
    vertical-align: top;
  }

  .complete .idx {
    color: silver;
  }

  .expected .idx {
    color: orange;
  }

  .incoming .idx {
    color: red;
  }

  .idx {
    text-align: right;
  }

  .idx:after {
    content: ".";
  }

  .fst, .snd {
    display: none;
  }

  .trd {
  }

  h1 {
    text-transform: uppercase;
  }
</style>

<div id="event-flows" class="row"></div>

<script>
  var show = new Set({{ show | tojson }})

  var code = ''
  for (kind of show) {
    code += '<div class="column ' + kind + '">' +
            '<h1>' + kind + '</h1>' +
            '<div class="events flow" id="flow-' + kind + '">' +
            '<div class="complete"></div>' +
            '<div class="expected"><em>no events yet</em></div>' +
            '<div class="incoming"></div>' +
            '</div>' +
            '</div>';
  }
  document.getElementById("event-flows").innerHTML = code;

  var events = new EventSource("{{ data }}");

  var listen = function (kind) {
    var root = document.getElementById("flow-" + kind);
    return function (event) {
      var json = JSON.parse(event.data);

      var elem = root.getElementsByClassName("complete")[0];
      for (data of json.text.complete) {
        elem.appendChild(node(data));
      }

      var elem = root.getElementsByClassName("expected")[0];
      elem.innerHTML = '';
      for (data of json.text.expected) {
        elem.appendChild(node(data));
      }

      var elem = root.getElementsByClassName("incoming")[0];
      elem.innerHTML = '';
      for (data of json.text.incoming) {
        elem.appendChild(node(data));
      }

      root.scrollIntoView(false);
    }
  }

  var node = function (data) {
    var elem = document.createElement("div");
    elem.className = "data";
    elem.innerHTML = html(data);
    return elem;
  }

  var html = function (data) {
    var zero = data[0] + '' // need the string not promise
    zero = zero.substring(0, zero.length - 2);
    return '<div class="idx item">' + zero    + '</div>' +
           '<div class="fst item">' + data[0] + '</div>' +
           '<div class="snd item">' + data[1] + '</div>' +
           '<div onclick="popup(this)"' +
               ' class="trd item">' + data[2] + '</div>';
  }

  var popup = function (elem) {
    var wind = window.open("", "_blank");
    var code = '<html><head></head><body>' +
               elem.parentElement.innerHTML +
               '</body></html>';
    wind.document.open();
    wind.document.write(code);
    wind.document.close();
  }

  events.onmessage = function (event) {
     for (kind of show) {
       listen(kind)(event);
     }
  }
  for (kind of show) {
    events.addEventListener(kind, listen(kind));
  }
</script>
