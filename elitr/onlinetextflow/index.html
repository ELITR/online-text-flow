<!DOCTYPE html>

<title>ELITR Online Text Flow</title>

<style>
  :root {
    --elitrblue: rgb(10, 80, 225);
  }

  .row {
    display: flex;
    flex-direction: row;
  }

  .column {
    flex: 1 1 50%;
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    padding-right: 10px;
  }

  .column.hide {
    display: none;
  }

  .complete {
    display: table-row-group;
    color: black;
  }

  .expected {
    display: table-row-group;
    color: gray;
  }

  .incoming {
    display: table-row-group;
    color: silver;
  }

  .flexible {
    height: 300px;
  }

  .flow {
    display: table;
    table-layout: fixed;
    width: 100%; // !!!
  }

  .data {
    display: table-row;
  }

  .item {
    display: table-cell;
    padding-right: 10px;
    vertical-align: top;
  }

  .complete .idx {
    color: silver;
  }

  .expected .idx {
    color: orange;
  }

  .incoming .idx {
    color: red;
  }

  .idx {
    text-align: right;
    padding-right: 12px;
    width: 36px;
  }

  .idx:after {
    content: ".";
  }

  .fst, .snd {
    display: none;
  }

  .trd {
  }

  h1 {
    text-transform: uppercase;
  }

  a {
    text-decoration: none;
  }

  img {
    display: block;
    margin: 0px 0px 20px 0px;
  }

  body {
    overflow-y: scroll;
  }

  .bar {
    position: fixed;
    right: 0px;
    top: 5px;
    width: 80px;
    height: 400px;
  }

  .bar button {
    display: block;
    width: 60px;
    border: 1px solid var(--elitrblue);
    border-radius: 0px;
    margin: 5px 10px;
    padding: 1px;
    height: 30px;
    font-family: inherit;
    font-size: inherit;
    font-weight: bold;
    position: relative;
    text-transform: uppercase;
    outline: none;
    color: white;
    background-color: var(--elitrblue);
  }

  .bar button.hide {
    color: var(--elitrblue);
    background-color: white;
  }

  #content {
    padding-right: 80px;
  }
</style>

<div class="row" id="content"></div>
<div class="bar">
 <a href="https://elitr.eu/" target="_blank">
   <img src="https://elitr.eu/wp-content/uploads/2019/01/logo-elitr-300x268.png" width="75" height="67">
 </a>
 <div id="control"></div>
</div>

<script>
  var menu = new Set({{ menu | tojson }});

  var code = '';
  for (let kind of menu) {
    code += '<div class="column ' + kind + '" id="column-' + kind + '">' +
            '<h1>' + kind + '</h1>' +
            '<div class="events flow">' +
            '<div class="complete" id="complete-' + kind + '"></div>' +
            '<div class="expected" id="expected-' + kind + '">' +
            '<em>no events yet</em></div>' +
            '<div class="incoming" id="incoming-' + kind + '"></div>' +
            '<div class="flexible" id="flexible-' + kind + '"></div>' +
            '</div>' +
            '</div>';
  }
  document.getElementById("content").innerHTML = code;

  var code = '';
  for (let kind of menu) {
    code += '<button onclick="toggle(this)" type="button" name="' + kind +
                  '" id="button-' + kind + '">' + kind + '</button>';
  }
  document.getElementById("control").innerHTML = code;

  var scroll = true;
  var viewer = new IntersectionObserver(function (ents) {
      scroll = ents.some(ent => ent.isIntersecting);
    }, {threshold: [0.0]});
  for (let elem of document.getElementsByClassName("expected")) {
    viewer.observe(elem);
  }
  for (let elem of document.getElementsByClassName("incoming")) {
    viewer.observe(elem);
  }

  var events = new EventSource("{{ data }}");

  var node = function (data) {
    var elem = document.createElement("div");
    elem.className = "data";
    elem.innerHTML = html(data);
    return elem;
  }

  var html = function (data) {
    var zero = data[0] + '' // need the string not promise
    zero = zero.substring(0, zero.length - 2);
    return '<div class="idx item">' + zero    + '</div>' +
           '<div class="fst item">' + data[0] + '</div>' +
           '<div class="snd item">' + data[1] + '</div>' +
           '<div onclick="popup(this)"' +
               ' class="trd item">' + data[2] + '</div>';
  }

  var popup = function (elem) {
    var wind = window.open("", "_blank");
    var code = '<!DOCTYPE html>' + elem.parentElement.innerHTML;
    wind.document.open();
    wind.document.write(code);
    wind.document.close();
  }

  var adjust = function (expected, incoming, flexible, height) {
    var fill = expected.scrollHeight + incoming.scrollHeight;
    var high = (height > fill) ? (height - fill) : 0;
    flexible.style.height = high + "px";
  }

  var listen = {};

  for (let kind of menu) {

    let complete = document.getElementById("complete-" + kind);
    let expected = document.getElementById("expected-" + kind);
    let incoming = document.getElementById("incoming-" + kind);
    let flexible = document.getElementById("flexible-" + kind);

    let height = parseInt(window.getComputedStyle(flexible)
                                .getPropertyValue("height"));

    adjust(expected, incoming, flexible, height);

    listen[kind] = function (event) {

      var json = JSON.parse(event.data);

      for (let data of json.text.complete) {
        complete.appendChild(node(data));
      }

      expected.innerHTML = '';
      for (let data of json.text.expected) {
        expected.appendChild(node(data));
      }

      incoming.innerHTML = '';
      for (let data of json.text.incoming) {
        incoming.appendChild(node(data));
      }

      adjust(expected, incoming, flexible, height);

      if (scroll) {
        let canvas = document.documentElement;
        canvas.scroll(0, canvas.scrollHeight);
      }
    }
  }

  let hide = JSON.parse(sessionStorage.getItem("hide") || "[]");

  var show = new Set(menu);
  for (let kind of hide) {
    show.delete(kind);
    document.getElementById("button-" + kind).classList.toggle("hide");
    document.getElementById("column-" + kind).classList.toggle("hide");
  }

  for (let kind of show) {
    events.addEventListener(kind, listen[kind]);
  }

  events.onmessage = function (event) {
    for (let kind of show) {
      listen[kind](event);
    }
  }

  var toggle = function (elem) {
    let kind = elem.name;
    elem.classList.toggle("hide");
    document.getElementById("column-" + kind).classList.toggle("hide");
    let hide = JSON.parse(sessionStorage.getItem("hide") || "[]");
    let indx = hide.indexOf(kind);
    if (indx < 0) {
      hide.push(kind);
      show.delete(kind);
      events.removeEventListener(kind, listen[kind]);
    }
    else {
      hide.splice(indx, 1);
      show.add(kind);
      events.addEventListener(kind, listen[kind]);
    }
    sessionStorage.setItem("hide", JSON.stringify(hide));
  }
</script>
